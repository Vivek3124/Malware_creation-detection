# -*- coding: utf-8 -*-
"""
Created on Wed Feb 16 20:47:12 2022

@author: vivek
"""
import os, csv
from sys import argv

# this function get details about all the files in the given path 
def extract_file_details(path):
    # first get all files
    files = os.listdir(path)
    
    # this below list below store details about all files
    files_list = []
    
    for file in files:
        #print("File/directory in scan for gathering details "+file)
        # skipping the folder .spyProject created for checkpoints in program written
        if file[:1] == ".":
            continue
        
        # if given file is itself a directory
        if os.path.isdir(path+"/"+file):
            # then extend the files_list by recursively calling the extract_file_details
            files_list.extend(extract_file_details(path+"/"+file))
       
        # else get details of files
        else:
            # get filesize
            filesize = os.path.getsize(path+"/"+file)
            # get file_modifying_time
            file_modifying_time = os.path.getmtime(path+"/"+file)
            # create list of above data and starting with file name
            file_data = [file,filesize,file_modifying_time]
            # append the above created list of details into files_list
            files_list.append(file_data)
    
    return files_list


# this will write the files_list into harddrive directory with name as file_details.txt 
def write_file_details(files_list):
    
    # if old file record exist delete it
    if (os.path.exists("file_details.txt")):
         os.remove("file_details.txt")
    # create a file with name file_details.txt and write using csv.writer method
    file  = open("file_details.txt",'w')
    writer = csv.writer(file)
    writer.writerows(files_list)


# this function checks for modifications in files
def check_for_modifications():
    
    # first open the file_details file which stores periodically the detail of files
    file = open("file_details.txt",'r')
    
    # split lines and get a list of list form of data of file_details in previous_file_list
    files_list = file.read().splitlines()
    previous_file_list = []
    for file_detail in files_list:
        details = file_detail.split(',')
        previous_file_list.append(details)
    
    # get current status of file details using extract_file_details() function
    current_file_list = extract_file_details(os.path.abspath(""))
    
    
    # Match for each file, its current and previous details
    for curr in current_file_list:
        for prev in previous_file_list:
            
            # 0 index filename
            # 1 index filesize
            # 2 index file_modifying_time
            
            # if same file name
            if(curr[0] == prev[0]):
                print("File in scanning: ",curr[0])
                
                # if size or modifying time is different, file is modified
                # Since executable files are generally not modified
                if(str(curr[1]) != str(prev[1]) or str(curr[2]) != str(prev[2])):
                
                    print("WARNING ! FILE DETAILS MODIFIED\nVIRUS DETECTED")
                
                # else file is not modified
                else:
                    print("File is found to be clean")
    
# if first argument of virus detection is passed as true that will write file details into harddrive
# i.e. storing the current status
if argv[1] == "True":
    write_file_details(extract_file_details(os.path.abspath("virus_directory")))

# else if second argument of virus detection is passed as true that will mean,
# it is scanning for modifications so check_for_modifications() function is called
elif argv[2] == "True":
    check_for_modifications()